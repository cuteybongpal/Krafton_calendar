<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>달력 + 사이드바 + 로그인/회원가입</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f4f4f4;
    }

    .sidebar {
      background-color: #fff;
      min-height: 100vh;
      padding: 20px;
      box-shadow: 2px 0 6px rgba(0, 0, 0, 0.1);
    }

    .widget {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: .2rem;
    }

    .calendar-cell {
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      border-radius: .5rem;
      font-size: .75rem;
      cursor: pointer;
      padding: 2px;
      position: relative;
    }

    .calendar-cell.disabled {
      color: #bbb;
      cursor: not-allowed;
    }

    .calendar-cell.today {
      border: 1px solid #0d6efd;
    }

    .calendar-cell.selected {
      background-color: #0d6efd;
      color: white;
    }

    .calendar-event {
      font-size: .65rem;
      color: #0d6efd;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      width: 100%;
    }

    .weekday {
      font-weight: 600;
      text-align: center;
      font-size: .75rem;
      padding: .1rem 0;
    }
  </style>
</head>

<body>

  <div class="container-fluid">
    <div class="row">

      <!-- 왼쪽 사이드바 -->
      <div class="col-3 sidebar">

        <div class="widget">
          <h5>오늘 날짜</h5>
          <h4 id="today-date"></h4>
        </div>
        <div class="widget">
          <h5>오늘 급식</h5>
          <p>
            A : 된장찌개, 야채볶음밥<br>
            B : 김치찌개, 비빔밥
          </p>
        </div>
        <div class="widget">
          <h5>오늘 일정 분량</h5>
          <canvas id="todayChart" width="150" height="150"></canvas>
        </div>
        <div class="widget">
          <h5>
            {% if userId == None %}
            Guest
            {% else %}
            {{userId}}
            {% endif %}
            님 환영합니다!
          </h5>
        </div>
        {% if userId == None or userId == '' %}
        <div class="widget d-flex flex-column gap-2">
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#signupModal">회원가입</button>
          <button class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#loginModal">로그인</button>
        </div>
        {% else %}
        <div class="widget d-flex flex-column gap-2">
          <a href="/logout" class="btn btn-danger w-100">로그아웃</a>
        </div>
        {% endif %}
      </div>

      <!-- 오른쪽 달력 -->
      <div class="col-9 p-4">
        <div class="card shadow-sm">
          <div class="card-body">

            <!-- 달력 헤더 -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <button class="btn btn-outline-secondary btn-sm" id="prevBtn">&lt;</button>
              <h5 class="mb-0" id="monthLabel"></h5>
              <button class="btn btn-outline-secondary btn-sm" id="nextBtn">&gt;</button>
            </div>

            <!-- 요일 헤더 -->
            <div class="calendar-grid text-muted mb-1">
              <div class="weekday">월</div>
              <div class="weekday">화</div>
              <div class="weekday">수</div>
              <div class="weekday">목</div>
              <div class="weekday">금</div>
              <div class="weekday text-danger">토</div>
              <div class="weekday text-danger">일</div>
            </div>

            <!-- 날짜 그리드 -->
            <div id="calendarGrid" class="calendar-grid"></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 회원가입 모달 -->
  <div class="modal fade" id="signupModal" tabindex="-1" aria-labelledby="signupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">회원가입</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <form id="signupForm" action="/signup" method="post">
            <div class="mb-3">
              <label for="signupEmail" class="form-label">이메일</label>
              <input type="email" class="form-control" id="signupEmail" name="email" required>
            </div>
            <div class="mb-3">
              <label for="signupPassword" class="form-label">비밀번호</label>
              <input type="password" class="form-control" id="signupPassword" name="pw" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">회원가입</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 로그인 모달 -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">로그인</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm" action="/login" method="post">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">이메일</label>
              <input type="email" class="form-control" id="loginEmail" name="email" required>
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">비밀번호</label>
              <input type="password" class="form-control" id="loginPassword" name="pw" required>
            </div>
            <button type="submit" class="btn btn-success w-100">로그인</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- 일정 관리 모달 -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">일정 관리</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <h6 id="eventDateLabel"></h6>
          <ul id="eventList" class="list-group mb-3"></ul>

          <form id="eventForm" class="d-flex flex-column gap-2" action="/memo/create" method="post">
            <input type="hidden" name="date" id="eventFormDate">
            <div class="d-flex gap-2">
              <input type="time" class="form-control" id="startTime" name="startTime" required>
              <input type="time" class="form-control" id="endTime" name="endTime" required>
            </div>
            <input type="text" class="form-control" id="eventText" placeholder="일정 내용" name="content" required>
            <button type="submit" class="btn btn-primary">추가</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- 일정 수정 모달 -->
  <div class="modal fade" id="editEventModal" tabindex="1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">일정 수정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editEventForm" class="d-flex flex-column gap-2" action="/memo/modify" method="post">
            <input type="hidden" id="memoId" name="id">
            <div class="d-flex gap-2">
              <input type="time" class="form-control" id="editStartTime" name="editStartTime" required>
              <input type="time" class="form-control" id="editEndTime" name="editEndTime" required>
            </div>
            <input type="text" class="form-control" id="editText" name="editContent" placeholder="일정 내용" required>
            <button type="submit" class="btn btn-primary">저장</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <script>

    document.getElementById("today-date").innerText = new Date().toISOString().split('T')[0];

    const MIN_DATE = new Date(2025, 8, 1);
    const MAX_DATE = new Date(2026, 0, 31);
    let current = new Date(2025, 8, 1);
    let selected = null;
    const monthLabel = document.getElementById("monthLabel");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const grid = document.getElementById("calendarGrid");

    function formatDateKey(date) { return date.toISOString().split("T")[0]; }
    let selectedDateKey = null;

    function renderCalendar() {
      monthLabel.textContent = `${current.getFullYear()}년 ${current.getMonth() + 1}월`;
      prevBtn.disabled = new Date(current.getFullYear(), current.getMonth(), 1) <= MIN_DATE;
      nextBtn.disabled = new Date(current.getFullYear(), current.getMonth() + 1, 0) >= MAX_DATE;
      grid.innerHTML = "";
      const startDay = new Date(current.getFullYear(), current.getMonth(), 1);
      const endDay = new Date(current.getFullYear(), current.getMonth() + 1, 0);
      const startWeekDay = (startDay.getDay() + 6) % 7;

      let days = [];
      for (let i = 0; i < startWeekDay; i++) days.push(null);
      for (let d = 1; d <= endDay.getDate(); d++) days.push(new Date(current.getFullYear(), current.getMonth(), d));

      days.forEach(date => {
        const cell = document.createElement("div");
        cell.className = "calendar-cell border";

        if (date) {
          date.setHours(19)
          const key = formatDateKey(date);
          const dateDiv = document.createElement("div");
          dateDiv.textContent = date.getDate();
          cell.appendChild(dateDiv);

          const today = new Date();
          if (date.toDateString() === today.toDateString()) cell.classList.add("today");
          if (selected && date.toDateString() === selected.toDateString()) cell.classList.add("selected");
          if (date < MIN_DATE || date > MAX_DATE) {
            cell.classList.add("disabled");
          } else {
            cell.addEventListener("click", () => {
              selected = date;
              selectedDateKey = key;
              renderEventModal(selectedDateKey);
              new bootstrap.Modal(document.getElementById("eventModal")).show();
              renderCalendar();
            });
          }
        let memo = {{ memos | tojson }}
        for (let j = 0; j < memo.length; j++) {
          if (key == memo[j]["date"]) {
            const eventDiv = document.createElement("div");
            eventDiv.className = "calendar-event";
            eventDiv.textContent = `${memo[j]['startTime']}~${memo[j]['endTime']} ${memo[j]['content']}`;
            eventDiv.setAttribute("data-bs-toggle", "tooltip");
            eventDiv.setAttribute("title", memo[j]['content'] + "\n");
            cell.appendChild(eventDiv);
          }
        }
      }
    //todo : 채우기
    grid.appendChild(cell);
    });

    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
  }

    function renderEventModal(dateKey) {
      
      document.getElementById("eventDateLabel").textContent = dateKey;
      document.getElementById("eventFormDate").value = dateKey
      const list = document.getElementById("eventList");
      list.innerHTML = "";

      let memo = {{ memos| tojson }}
      for (let i = 0; i < memo.length; i++) {
        if (memo[i]['date'] != dateKey)
          continue
        const li = document.createElement("li");
        li.id = `${memo[i]['id']}`
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
        <span>${memo[i]['startTime']}~${memo[i]['endTime']} - ${memo[i]['content']}</span>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-warning" onclick="showMemoMod('${memo[i]['id']}')">수정</button>
          <a href="/memo/delete?id=${memo[i]['id']}" class="btn btn-sm btn-danger">삭제</a>
        </div>`;
        list.appendChild(li);
      }
    } 
    function showMemoMod(id) {
      $('.modal-backdrop').hide()
      $('#eventModal').hide()
      new bootstrap.Modal(document.getElementById("editEventModal")).show();
      $('#memoId').val(id)
    }
    prevBtn.addEventListener("click", () => { current.setMonth(current.getMonth() - 1); renderCalendar(); });
    nextBtn.addEventListener("click", () => { current.setMonth(current.getMonth() + 1); renderCalendar(); });
    renderCalendar();

    document.getElementById("signupForm").addEventListener("submit", e => {
      bootstrap.Modal.getInstance(document.getElementById("signupModal")).hide();
    });
    document.getElementById("loginForm").addEventListener("submit", e => {
      bootstrap.Modal.getInstance(document.getElementById("loginModal")).hide();
    });
    const ctx = document.getElementById('todayChart').getContext('2d');
    let todayChart = null;

    function renderTodayChart() {
        if (!Chart) return;
        const todayKey = formatDateKey(new Date());
        let memo = {{memos|tojson}}
        const todayEvents = [];
        
        for (let i = 0; i < memo.length; i++){
          if (memo[i]['date'] == todayKey)
            todayEvents.push({"startTime":memo[i]['startTime'],"endTime": memo[i]['endTime'],"content":memo[i]['content']})
        }
        
        let data = [];
        let names = []
        console.log(todayEvents)
        for (let i = 0; i < todayEvents.length; i++){
          console.log(todayEvents[i])
          const start = todayEvents[i]['startTime'].split(':').map(Number);
          const end = todayEvents[i]['endTime'].split(':').map(Number);
          const startMinutes = start[0]*60 + start[1];
          const endMinutes = end[0]*60 + end[1];
          data.push(Math.max(0, endMinutes - startMinutes));
          names.push(todayEvents[i]['content'])
        }
        console.log(data)
        console.log(names)
        if (data.length === 0) {
          data = [1];
          todayEvents.push('오늘 일정을 넣어주세요')
        }

        if (todayChart) todayChart.destroy();

        todayChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: names,
                datasets: [{
                    data: data,
                    backgroundColor: todayEvents.map((_, i) => `hsl(${i*60}, 70%, 60%)`),
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 12 } } },
                    tooltip: { callbacks: { label: (ctx) => data[ctx.dataIndex] + "분" } }
                }
            }
        });
    }
    
    renderCalendar();
    function updateCharts() { renderTodayChart(); }
    setTimeout(() => { renderTodayChart(); }, 0);
  </script>

</body>

</html>